---
// Client-side Mermaid diagram rendering
---

<script>
  import mermaid from 'mermaid'

  mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    securityLevel: 'loose',
    fontFamily: 'var(--font-sans)',
  })

  async function renderMermaidDiagrams() {
    // Find all code blocks with language "mermaid"
    const mermaidBlocks = document.querySelectorAll('pre code.language-mermaid, code.language-mermaid')

    for (const block of mermaidBlocks) {
      const pre = block.closest('pre') || block.parentElement
      if (!pre) continue

      const code = block.textContent || ''
      if (!code.trim()) continue

      // Create a container for the diagram
      const container = document.createElement('div')
      container.className = 'mermaid-diagram'

      try {
        const { svg } = await mermaid.render(`mermaid-${Math.random().toString(36).substring(2, 11)}`, code)
        container.innerHTML = svg
        pre.replaceWith(container)
      } catch (e) {
        console.error('Mermaid rendering error:', e)
      }
    }
  }

  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', renderMermaidDiagrams)
  } else {
    renderMermaidDiagrams()
  }

  // Re-run on Astro page transitions (View Transitions)
  document.addEventListener('astro:page-load', renderMermaidDiagrams)
</script>

<style is:global>
  .mermaid-diagram {
    display: flex;
    justify-content: center;
    margin: 1.5rem 0;
    overflow-x: auto;
  }

  .mermaid-diagram svg {
    max-width: 100%;
    height: auto;
  }

  /* Dark mode support */
  [data-theme="dark"] .mermaid-diagram {
    filter: invert(93%) hue-rotate(180deg);
  }
</style>
